{% extends "base.html" %}

{% block title %}Chapter 1 - Face Detection{% endblock %}

{% block content %}
<div class="row">
    <!-- Camera Feed Section -->
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">ðŸ“· Live Camera Feed</h5>
            </div>
            <div class="card-body p-0">
                <div class="video-container">
                    {% if camera_ready %}
                        <img src="{{ url_for('video_feed') }}" 
                             alt="Camera Feed"
                             class="img-fluid"
                             onerror="this.onerror=null; this.src=''; showCameraError();">
                    {% else %}
                        {% include 'partials/_camera_error.html' %}
                    {% endif %}
                </div>
            </div>
            <div class="card-footer text-muted">
                <small>
                    <i class="bi bi-info-circle"></i> 
                    Faces detected will be highlighted with green boxes
                </small>
            </div>
        </div>
    </div>

    <!-- Status Panel Section -->
    <div class="col-lg-4">
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">ðŸ“Š Today's Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <div class="stat-card">
                            <h2 class="text-primary">{{ stats.today_count }}</h2>
                            <p class="text-muted small">Present Today</p>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stat-card">
                            <h2 class="text-info">{{ stats.total_students }}</h2>
                            <p class="text-muted small">Total Students</p>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stat-card">
                            <h2 class="text-success">{{ "%.1f"|format(stats.attendance_rate) }}%</h2>
                            <p class="text-muted small">Attendance Rate</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">âš¡ System Status</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li>
                        <i class="bi bi-circle-fill text-{{ 'success' if camera_ready else 'danger' }}"></i>
                        Camera: {{ 'Ready' if camera_ready else 'Error' }}
                    </li>
                    <li>
                        <i class="bi bi-circle-fill text-success"></i>
                        Database: Connected
                    </li>
                    <li>
                        <i class="bi bi-circle-fill text-success"></i>
                        Face Detection: Active
                    </li>
                </ul>
            </div>
            <div class="card-footer">
                <small class="text-muted">
                    Last updated: <span id="last-updated">{{ current_time }}</span>
                </small>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-info">
            <h6>ðŸŽ¯ Chapter 1 Features Active:</h6>
            <ul class="mb-0">
                <li>âœ“ Real-time face detection with bounding boxes</li>
                <li>âœ“ Camera error handling and fallback</li>
                <li>âœ“ Statistics dashboard</li>
                <li>âœ“ Modular architecture</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-refresh stats every 30 seconds
setInterval(() => {
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            // Update stats on page
            console.log('Stats updated:', data);
        })
        .catch(error => console.error('Stats refresh failed:', error));
}, 30000);

// Show camera error
function showCameraError() {
    document.getElementById('video-container').innerHTML = `
        <div class="alert alert-danger m-4">
            <h5>âš  Camera Connection Lost</h5>
            <p>The camera connection was lost. Please check the connection and refresh the page.</p>
        </div>
    `;
}
</script>
{% endblock %}